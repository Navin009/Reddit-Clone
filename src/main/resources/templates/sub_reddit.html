<!DOCTYPE html>
<html lang="en" xmlns:th=“http://www.thymeleaf.org”>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reddit</title>
    <link rel="icon" type="image/png" href="./../static/images/reddit.png" th:href="@{/images/reddit.png}">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.6.0/font/bootstrap-icons.min.css"
        integrity="sha512-7w04XesEFaoeeKX0oxkwayDboZB/+AKNF5IUE50fCUDUywLvDN4gv2513TLQS+RDenAeHEK3O40jZZVrkpnWWw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src='https://kit.fontawesome.com/a076d05399.js' crossorigin='anonymous'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/css/bootstrap.min.css"
        integrity="sha384-uWxY/CJNBR+1zjPWmfnSnVxwRheevXITnMqoEIeG1LJrdI0GlVs/9cVSyPYXdcSF" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/trending.css">
    <link rel="stylesheet" href="/css/cards.css">
    <link rel="stylesheet" href="/css/sub_reddit.css">
</head>

<body>
    <div th:replace="fragments/header :: header"></div>
    <div sec:authorize="isAnonymous()" th:replace="fragments/trending :: trending"></div>
    <div class="container">
        <article>
            <div class="new-post" sec:authorize="isAuthenticated()">
                <img th:src="@{/images/reddit-logo.png}" alt="logo" onclick="location.href='/viewProfile'">
                <input class="new-post-input" type="text" placeholder="Create Post"
                    onclick="location.href='/viewCreatePostPage'">
                <button class="btn" onclick="location.href='/viewCreatePostPage'">
                    <i class="bi bi-image"></i>
                </button>
                <button class="btn  mx-2" onclick="location.href='/viewCreatePostPage'">
                    <i class="bi bi-link-45deg"></i>
                </button>
            </div>

            <div class="row subreddit" th:if="${subReddit != null}">
                <header class="mb-4">
                    <div class="row">
                        <div class="col-md-4 ">
                            <h4 class="fw-bolder mb-1" th:text="${subReddit.name}">Subreddit name</h4>
                            <div class="text-muted fst-italic mb-2">
                                [[${#dates.format(subReddit.createdAt, 'MMM dd, yyyy h:mm a')}]]
                            </div>
                            <button type="button" class="btn btn-dark shadow" disabled>
                                Karma <span class="badge badge-pill badge-light" th:text="${karma}">9</span>
                            </button>
                        </div>

                        <div class="col-lg-8">
                            <th:block th:if="${isSubscribed}">
                                <form th:action="@{/unsubscribe}" method="get">
                                    <input type="hidden" th:value="${subReddit.id}" name="id">
                                    <button class="btn btn-outline-primary" type="submit"
                                        style="border-radius: 20px;padding:5px 20px">Joined</button>
                                </form>
                            </th:block>
                            <th:block th:if="${!isSubscribed}">
                                <form th:action="@{/subscribe}" method="get">
                                    <input type="hidden" th:value="${subReddit.id}" name="id">
                                    <button class="btn btn-outline-primary" type="submit"
                                        style="border-radius: 20px;padding:5px 20px">Join</button>
                                </form>
                            </th:block>

                        </div>
                    </div>
                </header>
            </div>
            <p class="fw-bolder mb-1 mx-2"><b>Posts</b></p>
            <div class="sorting">
                <th:block th:if="${subReddit != null}">
                    <div class="sort-tab-block">
                        <a th:href="@{'/new/'+${subReddit.id}}" style="text-decoration: none; color: black;">New</a>
                    </div>
                    <div class="sort-tab-block">
                        Top
                        <div class="top-drop-list">
                            <a th:href="@{'/top/t=day/'+${subReddit.id}}">Today</a>
                            <a th:href="@{'/top/t=week/'+${subReddit.id}}">This Week</a>
                            <a th:href="@{'/top/t=month/'+${subReddit.id}}">This Month</a>
                            <a th:href="@{'/top/t=year/'+${subReddit.id}}">This Year</a>
                        </div>
                    </div>
                </th:block>

                <th:block th:if="${subReddit == null}">
                    <div class="sort-tab-block" onclick="location.href='/new'">New</div>
                    <div class="sort-tab-block">
                        Top
                        <div class="top-drop-list">
                            <a href="/top/t=day">Today</a>
                            <a href="/top/t=week">This Week</a>
                            <a href="/top/t=month">This Month</a>
                            <a href="/top/t=year">This Year</a>
                        </div>
                    </div>
                </th:block>
            </div>
            <!-- Content-->
            <th:block th:each="post : ${posts}">
                <div class="post-box">
                    <div class="votes-div">
                        <form action="/vote" method="get">
                            <input type="hidden" name="postId" th:value="${post.id}" />
                            <input type="hidden" name="upVote" value="true" />
                            <input type="hidden" name="isHomePage" th:value="${subReddit} != null" />
                            <th:block
                                th:if="${!userExist or !votes.containsKey(post.id) or !votes.get(post.id).containsKey(user.id) or !votes.get(post.id).get(user.id).upVoted }">
                                <button type="submit">
                                    <i class="bi bi-arrow-up-circle"></i>
                                </button>
                            </th:block>
                        </form>
                        <form action="/vote" method="get">
                            <input type="hidden" name="postId" th:value="${post.id}" />
                            <input type="hidden" name="upVote" value="false" />
                            <input type="hidden" name="isHomePage" th:value="${subReddit} != null" />
                            <th:block th:if="${userExist
                                                                and votes.containsKey(post.id)}
                                                                and ${votes.get(post.id).containsKey(user.id)}
                                                                and ${votes.get(post.id).get(user.id).upVoted} ">
                                <button type="submit">
                                    <i class="bi bi-arrow-up-circle-fill"></i>
                                </button>
                            </th:block>
                        </form>
                        <span class="" style="color: rgb(26, 26, 27);">&nbsp&nbsp&nbsp[[${post.voteCount}]]</span>
                        <form action="/vote" method="get">
                            <input type="hidden" name="postId" th:value="${post.id}" />
                            <input type="hidden" name="downVote" value="true" />
                            <input type="hidden" name="isHomePage" th:value="${subReddit} != null" />
                            <th:block th:if="${!userExist
                                                                or !votes.containsKey(post.id)}
                                                                or ${!votes.get(post.id).containsKey(user.id)}
                                                                or ${!votes.get(post.id).get(user.id).downVoted}">
                                <button type="submit">
                                    <i class="bi bi-arrow-down-circle"></i>
                                </button>
                            </th:block>
                        </form>
                        <form action="/vote" method="get">
                            <input type="hidden" name="postId" th:value="${post.id}" />
                            <input type="hidden" name="downVote" value="false" />
                            <input type="hidden" name="isHomePage" th:value="${subReddit} != null" />
                            <th:block th:if="${userExist
                                                                and votes.containsKey(post.id)}
                                                                and ${votes.get(post.id).containsKey(user.id)}
                                                                and  ${votes.get(post.id).get(user.id).downVoted}">
                                <button type="submit">
                                    <i class="bi bi-arrow-down-circle-fill"></i>
                                </button>
                            </th:block>
                        </form>
                    </div>
                    <div class="col-md-11">
                        <a th:href="'/viewPost/'+${post.id}" style="text-decoration:none; color:black">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title" th:text="${post.title}" th:field="${post.title}">
                                    </h6>
                                    <p class="text-muted fst-italic mb-2">
                                        [[${#dates.format(post.createdAt, 'MMM dd, yyyy h:mm a')}]]
                                    </p>
                                    <p class="card-text" th:text="${#strings.abbreviate(post.content,100)}"></p>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </th:block>
            <div th:if="postsLength == 0">
                No post is available
            </div>
        </article>
        <aside>
            <!-- Search widget-->
            <div class="about-community" th:if="${subReddit != null}">
                <div class="community-header">About Community</div>
                <div class="community-body">
                    <p th:text="${subReddit.description}"></p>
                    <div class="community-created">
                        Created [[${#dates.format(subReddit.createdAt, 'MMM dd, yyyy h:mm a')}]]
                    </div>
                    <button class="btn btn-success rounded-pill w-75 m-2"
                        onclick="location.href='/viewCreatePostPage'">Create
                        Post</button>
                </div>
            </div>
            <!-- Subreddits List-->
            <div class="subreddit-box">
                <div class="subreddit-header">Subreddits</div>
                <div class="subreddit-body">
                    <div th:each="subreddit : ${subreddits}" class="subreddit-body-row">
                        <i class="bi bi-people-fill fa-2x"></i>
                        <a th:href="'/reddit/'+${subreddit.id}" th:text="${subreddit.name}"></a>
                    </div>
                </div>
            </div>
        </aside>
    </div>
    <script>
        function redirect(url) {
            debugger;
            window.location.href = url;
        }
    </script>
</body>

</html>